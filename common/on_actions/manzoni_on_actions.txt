######################
# Manzoni ON ACTIONS #
######################

#by Marco Dandolo & Lord R

######################

on_yearly_pulse_country = { 
	on_actions = {
		manzoni_on_yearly_pulse_country
#		manzoni_on_yearly_pulse_country_writers #TODO: uncomment when Writers are added again
#		manzoni_on_yearly_pulse_country_local_writers #TODO: uncomment when Writers are added again
		delay = { days = { 45 330 } }
	}
}

on_decade_pulse_country = {
	on_actions = {
		manzoni_on_decade_pulse_country
	}
}

on_character_creation = {
	on_actions = {
		manzoni_on_character_creation
	}
}

manzoni_on_yearly_pulse_country = {
	events = {
		###Great Britain###
		manzoni.1000 # Manzoni 1000: Sherlock Holmes published

		###Switzerland###
		manzoni.1100 #Manzoni 1100: Heidi published
		manzoni.1101 #Manzoni 1101: Kleider machen Leute published
		manzoni.1102 #Manzoni 1102: Uli der Knecht published
		manzoni.1103 #Manzoni 1103: Steppenwolf published
		manzoni.1104 #Manzoni 1104: Monsieur Crépin published
		manzoni.1105 #Manzoni 1105: Aline published

		###Italy###
		manzoni.1200 #Manzoni 1200: Alessandro Manzoni, I Promessi Sposi
		manzoni.1202 #Manzoni 1202: Giacomo Leopardi, La Ginestra
		manzoni.1203 #Manzoni 1203: Giosué Carducci, Rime Nuove
		manzoni.1204 #Manzoni 1204: Giovanni Pascoli, Myricae
		manzoni.1205 #Manzoni 1205: Italo Svevo, Zeno's Conscience
		manzoni.1206 #Manzoni 1206: Gabriele D'Annunzio, Il Piacere
		manzoni.1207 #Manzoni 1207: Carlo Collodi, Pinocchio
		manzoni.1208 #Manzoni 1208: Edoardo De Amicis, Cuore

		###Germany###
		manzoni.1300 #Manzoni 1300: Heinrich Heine, Deutschland, ein Wintermärchen
		manzoni.1302 #Manzoni 1302: Joseph von Eichendorff, Mondnacht
		manzoni.1303 #Manzoni 1303: The Weavers in $STATE$ [Leads to Manzoni 1304: Heinrich Heine, Weberlied]
		manzoni.1305 #Manzoni 1305: Gerhart Hauptmann, Die Weber
	}

	#Death Event for Maria Luisa von Habsburg
	effect = {
		if = {
			limit = {
				NOT = {
					has_global_variable = manzoni_maria_luisa_dead
				}
				exists = c:PAR
				exists = c:LUC
				c:LUC = {
					is_ai = yes
				}
				year >= 1847
				year < 1850
			}
			set_global_variable = manzoni_maria_luisa_dead
			random_character = {
				limit = {
					has_variable = is_maria_luisa_var
				}
				kill_character = yes
			}
		}
	}
}

manzoni_on_yearly_pulse_country_writers = {
	trigger = { has_variable = manzoni_writer_var }
	random_events = {
		chance_to_happen = 100
		chance_of_no_event = {
			value = 50
			if = {
				limit = {
					var:manzoni_writer_var = {
						has_trait = meticulous
					}
				}
				add = -10
			}
			if = {
				limit = {
					var:manzoni_writer_var = {
						OR = {
							has_trait = alcoholic
							has_trait = opium_addiction
							has_trait = cocaine_addiction
							has_trait = psychological_affliction
							has_trait = senile
						}
					}
				}
				add = -30
			}
			if = {
				limit = {
					var:manzoni_writer_var = {
						has_trait = persistent
					}
				}
				add = 10
			}
			if = {
				limit = {
					var:manzoni_writer_var = {
						has_trait = reckless
					}
				}
				add = 10
			}
		}

		1 = manzoni.100 #Manzoni 100: [Book Title], a true masterwork
		19 = manzoni.101 #Manzoni 101: [Book Title] lauded by critics!
		70 = manzoni.102 #Manzoni 102: [Book Title] published
		10 = manzoni.103 #Manzoni 103: [Book Title] ripped apart by critics
	}

	effect = {
		manzoni_add_x_literary_tradition_effect = {
			AMOUNT = 1
		}
	}
}

manzoni_on_yearly_pulse_country_local_writers = {
	trigger = {
		has_variable_list = mr_local_writers_list
		variable_list_size = {
			name = mr_local_writers_list
			value > 0
		}
	}
#	random_events = {
#		chance_to_happen = 100
#		chance_of_no_event = {
#			value = 90
#			if = {
#				limit = {
#					variable_list_size  = {
#						name = mr_local_writers_list
#						value = 2
#					}
#				}
#				subtract = 2.5
#			}
#			else_if = {
#				limit = {
#					variable_list_size  = {
#						name = mr_local_writers_list
#						value >= 3
#					}
#				}
#				subtract = 6.7
#			}
#		}
#	}

	effect = {

		#Adds 1 Literary Tradition for each local writer
		if = {
			limit = {
				has_variable_list = mr_local_writers_list
				variable_list_size  = {
					name = mr_local_writers_list
					value = 1
				}
			}
			manzoni_add_x_literary_tradition_effect = {
				AMOUNT = 1
			}
		}
		else_if = {
			limit = {
				has_variable_list = mr_local_writers_list
				variable_list_size  = {
					name = mr_local_writers_list
					value = 2
				}
			}
			manzoni_add_x_literary_tradition_effect = {
				AMOUNT = 2
			}
		}
		else_if = {
			limit = {
				has_variable_list = mr_local_writers_list
				variable_list_size  = {
					name = mr_local_writers_list
					value = 3
				}
			}
			manzoni_add_x_literary_tradition_effect = {
				AMOUNT = 3
			}
		}
		else = {
			manzoni_add_x_literary_tradition_effect = {
				AMOUNT = 3
			}

			#This part removes writers if there are more than 3
			set_local_variable = {
				name = counter_local_var
				value = 0
			}
			ordered_in_list = {
				variable = mr_local_writers_list
				order_by = var:manzoni_writer_experience
				max = 1000
				check_range_bounds = no

				change_local_variable = {
					name = counter_local_var
					add = 1
				}
				if = {
					limit = { local_var:counter_local_var > 3 }
					remove_list_variable = {
						name = mr_local_writers_list
						target = this
					}
				}
			}
		}

		#This part adds or removes a random amount of reputation
		ordered_in_list = {
			variable = mr_local_writers_list
			max = 3
			check_range_bounds = no

			void_writer_experience_gain_effect = { AMOUNT = local_writer_experience_gain_value }
		}
	}
}

manzoni_on_character_creation = {
	effect = {
		if = {
			limit = {
				OR = {
					has_culture = cu:south_italian
					has_culture = cu:north_italian
				}
				owner = {
					country_has_primary_culture = cu:united_italian
				}
			}
			change_character_culture = cu:united_italian
		}
		if = {
			limit = {
				OR = {
					has_culture = cu:south_german
					has_culture = cu:north_german
					has_culture = cu:alemannic
				}
				owner = {
					country_has_primary_culture = cu:united_german
				}
			}
			change_character_culture = cu:united_german
		}
		if = {
			limit = {
				OR = {
					has_culture = cu:alemannic
					has_culture = cu:francoprovencal
					has_culture = cu:ticinese
					has_culture = cu:rumantsch
				}
				owner = {
					country_has_primary_culture = cu:united_swiss
				}
			}
			change_character_culture = cu:united_swiss
		}
	}
}

manzoni_on_decade_pulse_country = {
	events = {
		manzoni.2
	}
}