######################
# Manzoni ON ACTIONS #
######################

#by Marco Dandolo & Lord R

######################

on_yearly_pulse_country = { 
	on_actions = {
		manzoni_on_yearly_pulse_country
		manzoni_on_yearly_pulse_country_writers
		manzoni_on_yearly_pulse_country_local_writers
		manzoni_on_yearly_pulse_country_book_license
		manzoni_on_yearly_pulse_country_random
		delay = { days = { 45 330 } }
	}
}

on_decade_pulse_country = {
	on_actions = {
		manzoni_on_decade_pulse_country
	}
}

on_character_creation = {
	on_actions = {
		manzoni_on_character_creation
	}
}

on_building_built = {
	on_actions = {
		manzoni_on_building_built
	}
}

manzoni_on_yearly_pulse_country = {
	events = {
		###Switzerland###
		manzoni.1100 #Manzoni 1100: Heidi published
		manzoni.1101 #Manzoni 1101: Kleider machen Leute published
		manzoni.1102 #Manzoni 1102: Uli der Knecht published
		manzoni.1103 #Manzoni 1103: Steppenwolf published
		manzoni.1104 #Manzoni 1104: Monsieur Crépin published
		manzoni.1105 #Manzoni 1105: Aline published

		###Italy###
		manzoni.1200 #Manzoni 1200: Alessandro Manzoni, I Promessi Sposi
		manzoni.1202 #Manzoni 1202: Giacomo Leopardi, La Ginestra
		manzoni.1203 #Manzoni 1203: Giosué Carducci, Rime Nuove
		manzoni.1204 #Manzoni 1204: Giovanni Pascoli, Myricae
		manzoni.1205 #Manzoni 1205: Italo Svevo, Zeno's Conscience
		manzoni.1206 #Manzoni 1206: Gabriele D'Annunzio, Il Piacere
		manzoni.1207 #Manzoni 1207: Carlo Collodi, Pinocchio
		manzoni.1208 #Manzoni 1208: Edoardo De Amicis, Cuore

		###Germany###
		manzoni.1300 #Manzoni 1300: Heinrich Heine, Deutschland, ein Wintermärchen
		manzoni.1302 #Manzoni 1302: Joseph von Eichendorff, Mondnacht
		manzoni.1303 #Manzoni 1303: The Weavers in $STATE$ [Leads to Manzoni 1304: Heinrich Heine, Weberlied]
		manzoni.1305 #Manzoni 1305: Gerhart Hauptmann, Die Weber
	}

	#Death Event for Maria Luisa von Habsburg
	effect = {
		manzoni_add_x_publications_country_effect = {
			AMOUNT = manzoni_yearly_publications_value
		}
		if = {
			limit = {
				NOT = {
					has_global_variable = manzoni_maria_luisa_dead
				}
				exists = c:PAR
				exists = c:LUC
				c:LUC = {
					is_ai = yes
				}
				year >= 1847
				year < 1850
			}
			set_global_variable = manzoni_maria_luisa_dead
			random_character = {
				limit = {
					has_variable = is_maria_luisa_var
				}
				kill_character = yes
			}
		}

		#Yearly Literary Tradition
		manzoni_add_x_literary_tradition_effect = { AMOUNT = manzoni_yearly_literary_tradition_value }
	}
}

manzoni_on_yearly_pulse_country_writers = {
	trigger = { has_variable = manzoni_writer_var } #Only relevant if the country has a writer

	effect = {
		#Bestseller Events/Effects
		#Either fires an Event/Effect or nothing depending on the writers genre and the genre preference.
		random_list = {
			99 = { # No effect 99% as a standard
				var:manzoni_writer_var = {
					manzoni_add_yearly_publications_character_effect = yes #If no Bestseller, there is a chance for a normal literary work
				}

				modifier = {
					if = {
						limit = {
							manzoni_writer_meets_taste_trigger = yes
						}
						add = -74 #In case of the writer meeting the taste, the chance gets lowered to 25%
					}
					if = {
						limit = {
							manzoni_writer_close_taste_trigger = yes
						}
						add = -14 #In case of the writer is close to the taste, the chance gets lowered to 75%
					}
					if = {
						limit = {
							var:manzoni_writer_var = {
								OR = {
									has_trait = ambitious
									has_trait = persistent
									has_trait = innovative
								}
							}
						}
						add = -3 #Positive Traits raise the chance by 3%
					}
					if = {
						limit = {
							var:manzoni_writer_var = {
								OR = {
									has_trait = alcoholic
									has_trait = opium_addiction
									has_trait = cocaine_addiction
									has_trait = psychological_affliction
								}
							}
						}
						add = 3 #Negative Traits lower the chance by 3%
					}
					if = {
						limit = {
							var:manzoni_writer_var = {
								has_trait = senile
							}
						}
						add = 10 #Senile lowers the chance by 10%
					}
				}
			}
			1 = { #Event/Effect 1% Standard chance
				var:manzoni_writer_var = { #Sets the scope to be used in the next effect
					save_scope_as = manzoni_writer_scope
				}

				#Actual effect works with scope so it can be used for both local and national writer
				manzoni_bestseller_event_or_effect_chooser_effect = yes

				modifier = {
					if = {
						limit = {
							manzoni_writer_meets_taste_trigger = yes
						}
						add = 74 #In case of the writer meeting the taste, the chance gets lowered to 25%
					}
					if = {
						limit = {
							manzoni_writer_close_taste_trigger = yes
						}
						add = 14 #In case of the writer is close to the taste, the chance gets lowered to 75%
					}
					if = {
						limit = {
							var:manzoni_writer_var = {
								OR = {
									has_trait = ambitious
									has_trait = persistent
									has_trait = innovative
								}
							}
						}
						add = 3 #Positive Traits raise the chance by 3%
					}
					if = {
						limit = {
							var:manzoni_writer_var = {
								OR = {
									has_trait = alcoholic
									has_trait = opium_addiction
									has_trait = cocaine_addiction
									has_trait = psychological_affliction
								}
							}
						}
						add = -3 #Negative Traits lower the chance by 3%
					}
					if = {
						limit = {
							var:manzoni_writer_var = {
								has_trait = senile
							}
						}
						add = -10 #Senile lowers the chance by 10%
					}
				}
			}
		}
	}
}

manzoni_on_yearly_pulse_country_local_writers = {
	trigger = {
		has_variable_list = mr_local_writers_list
		variable_list_size = {
			name = mr_local_writers_list
			value > 0
		}
	}

	effect = {
		if = { #Only executed if there is a local writer
			limit = {
				has_variable_list = mr_local_writers_list
				variable_list_size  = {
					name = mr_local_writers_list
					value >= 1
				}
			}
			
			#This part adds or removes a random amount of reputation
			ordered_in_list = {
				variable = mr_local_writers_list
				max = 3
				check_range_bounds = no

				void_writer_experience_gain_effect = { AMOUNT = local_writer_experience_gain_value }
			}

			#This part removes writers if there are more than 3
			if = {
				limit = {
					has_variable_list = mr_local_writers_list
					variable_list_size  = {
						name = mr_local_writers_list
						value > 3
					}
				}
				set_local_variable = {
					name = counter_local_var
					value = 0
				}
				ordered_in_list = {
					variable = mr_local_writers_list
					order_by = var:manzoni_writer_experience
					max = 1000
					check_range_bounds = no
	
					change_local_variable = {
						name = counter_local_var
						add = 1
					}
					if = {
						limit = { local_var:counter_local_var > 3 }
						remove_list_variable = {
							name = mr_local_writers_list
							target = this
						}
					}
				}
			}

			#Adds 1 Literary Tradition for each local writer
			if = {
				limit = {
					has_variable_list = mr_local_writers_list
					variable_list_size  = {
						name = mr_local_writers_list
						value >= 1
					}
				}

				manzoni_add_yearly_publications_character_effect = yes #If no Bestseller, there is a chance for a normal literary work
			}

			#Bestseller Events/Effects
			#Either fires an Event/Effect or nothing depending on the writers genre and the genre preference.
			random_list = {
				99 = { # No effect 99% as a standard
					modifier = {
						if = {
							limit = {
								manzoni_local_writer_meets_taste_trigger = yes
							}
							add = -74 #In case of the writer is meeting the taste, the chance gets lowered to 25%
						}
						if = {
							limit = {
								manzoni_local_writer_close_taste_trigger = yes
							}
							add = -14 #In case of the writer is close to the taste, the chance gets lowered to 75%
						}
					}
				}
				1 = { #Event/Effect 1% Standard chance
					#Makes the right local writer a scope
					if = {
						limit = { manzoni_local_writer_meets_taste_trigger = yes }
						random_in_list = {
							variable = mr_local_writers_list
							limit = { manzoni_local_writer_meets_taste_trigger = yes }
							save_scope_as = manzoni_writer_scope
						}
					}
					else_if = {
						limit = { manzoni_local_writer_close_taste_trigger = yes }
						random_in_list = {
							variable = mr_local_writers_list
							limit = { manzoni_local_writer_close_taste_trigger = yes }
							save_scope_as = manzoni_writer_scope
						}
					}
					else = {
						random_in_list = {
							variable = mr_local_writers_list
							save_scope_as = manzoni_writer_scope
						}
					}

					#Actual effect works with scope so it can be used for both local and national writer
					manzoni_bestseller_event_or_effect_chooser_effect = yes

					modifier = {
						if = {
							limit = {
								manzoni_local_writer_meets_taste_trigger = yes
							}
							add = 74 #In case of the writer is meeting the taste, the chance gets lowered to 25%
						}
						if = {
							limit = {
								manzoni_writer_close_taste_trigger = yes
							}
							add = 14 #In case of the writer is close to the taste, the chance gets lowered to 75%
						}
					}
				}
			}
		}
	}
}

manzoni_on_yearly_pulse_country_book_license = {
	events = {
		manzoni.12 #Manzoni 12: Literary Publisher
		manzoni.321 #Manzoni 321: Publisher gets Book License
	}
}

manzoni_on_yearly_pulse_country_random = {
	random_events = {
		1000 = 0
		10 = manzoni.11 #Manzoni 11: Public Publisher
		20 = manzoni.301 #Manzoni 301: Bibliomania
		5 = manzoni.302 #Manzoni 302: Has bibliomania passed its peak?
		25 = manzoni.303 #Manzoni 303: Bookclub
		30 = manzoni.304 #Manzoni 304: Thriving Book Industry
		20 = manzoni.311 #Manzoni 311: IG wants to buy bankrupt publisher
		20 = manzoni.312 #Manzoni 312: A publisher critical of the government
		15 = manzoni.322 #Manzoni 322: Foreign Pulp literature
		15 = manzoni.323 #Manzoni 323: Pirated Copies
	}
}

manzoni_on_character_creation = {
	effect = {
		if = {
			limit = {
				OR = {
					has_culture = cu:south_italian
					has_culture = cu:north_italian
				}
				owner = {
					country_has_primary_culture = cu:united_italian
				}
			}
			change_character_culture = cu:united_italian
		}
		if = {
			limit = {
				OR = {
					has_culture = cu:south_german
					has_culture = cu:north_german
					has_culture = cu:alemannic
				}
				owner = {
					country_has_primary_culture = cu:united_german
				}
			}
			change_character_culture = cu:united_german
		}
		if = {
			limit = {
				OR = {
					has_culture = cu:alemannic
					has_culture = cu:francoprovencal
					has_culture = cu:ticinese
					has_culture = cu:rumantsch
				}
				owner = {
					country_has_primary_culture = cu:united_swiss
				}
			}
			change_character_culture = cu:united_swiss
		}
	}
}

manzoni_on_decade_pulse_country = {
	events = {
		manzoni.2
	}
}

manzoni_on_building_built = {
	effect = {
		if = {
			limit = {
				owner = {
					NOT = {
						has_variable = manzoni_publisher_inauguration_happened
					}
					manzoni_has_printing_industry = yes
				}
			}
			owner = {
				trigger_event = {
					id = manzoni.10 #Manzoni 10: A new Publisher
					popup = yes
				}
			}
		}
	}
}
